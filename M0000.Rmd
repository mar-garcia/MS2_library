---
title: "Metabolite Details"
output: 
  html_document:
    toc: true
    toc_float: true
params:
  metabolite: "M0000"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

# Average Spectra

```{r}
library(plotly)
library(Spectra)
tmp_sps <- sps[sps$compound_id == m[i]]
tmp_sps <- tmp_sps[tmp_sps$raw_spectra == 0]
tmp_dt <- data.frame(
  mz = unlist(mz(tmp_sps)),
  int = unlist(intensity(tmp_sps))
)
tmp_dt <- tmp_dt[tmp_dt$mz <= precursorMz(tmp_sps), ]
tmp_dt <- rbind(tmp_dt, c(precursorMz(tmp_sps), 0))
tmp_dt$mz1 <- round(tmp_dt$mz, 4)
tmp_dt$mz <- tmp_dt$mz
plot_ly(data = tmp_dt, x = ~mz, y = ~int, type = "bar", 
        hovertext = ~mz1, hoverinfo = "text") %>% 
  add_text(text=~mz1, hoverinfo='none', textposition = 'top') %>% 
  layout(title = 'MS/MS Spectrum', showlegend = FALSE, 
         yaxis = list(title = "intensity"), 
         xaxis = list(title = "m/z", showticklabels = FALSE))
```


# Individual Spectra

```{r}
library(xcms)
library(MsCoreUtils)
tmp_sps <- sps[sps$compound_id == m[i]]
tmp_sps <- tmp_sps[tmp_sps$raw_spectra == 1]
do <- unique(tmp_sps$dataOrigin)
if(length(do) > 1){
  print("Update code!!!")
} else {
  ms1 <- readMSData(do, mode = "inMemory", msLevel. = 1L)
  chr <- chromatogram(ms1,
                      mz = mean(precursorMz(tmp_sps)) + 0.01 * c(-1, 1),
                      rt = mean(rtime(tmp_sps)) + 30 * c(-1, 1))
  dt1 <- data.frame(rt = rtime(chr[[1]]), 
                    int = intensity(chr[[1]]))
  dt2 <- data.frame(rt = rtime(tmp_sps))
  dt2$int <- dt1$int[closest(dt2$rt, dt1$rt)]
  
  a <- htmltools::tagList()
  a[[1]] <- as.widget(
    plot_ly(data = dt1, x = ~rt/60, y = ~int, mode = "lines", 
            type = "scatter") %>% 
      add_trace(data = dt2, x = ~rt/60, y = ~int, mode = "markers", 
                text= paste("Scan N.", tmp_sps$scanIndex)) %>% 
      layout(title = 'EIC', yaxis = list(title = "intensity"), 
             xaxis = list(title = "RT (min)"), showlegend = FALSE)
  )
  
  b <- htmltools::tagList()
  for(j in seq(length(tmp_sps))){
    tmp_dt <- data.frame(
      mz = mz(tmp_sps)[[j]],
      int = intensity(tmp_sps)[[j]]
    )
    tmp_dt <- tmp_dt[tmp_dt$mz <= precursorMz(tmp_sps)[j], ]
    tmp_dt <- rbind(tmp_dt, c(precursorMz(tmp_sps)[j], 0))
    tmp_dt$mz1 <- round(tmp_dt$mz, 4)
    tmp_dt$mz <- as.factor(tmp_dt$mz)
    b[[j]] <- as.widget(
      plot_ly(data = tmp_dt, x = ~mz, y = ~int, type = "bar", 
              hovertext = ~mz1, hoverinfo = "text")  %>% 
        layout(title = 'MS/MS Spectrum', yaxis = list(title = "intensity"), 
               xaxis = list(title = "m/z", showticklabels = FALSE))
    )
  }
}
a
b
```

